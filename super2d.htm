<style>
    * {
        margin: 0;padding: 0;font-family: sans-serif;
    }
</style>
<div id="i"></div>
<canvas id="a" style="background:#111517"></canvas>
<script>
    
    /* 
    
        - map
        - //player fire
        - //bullet disapears
            - //on collision
                - with map
                - player
                - red guys
        - red guys have wearpons
        - collision
        - player action update time dilatation for moment
        - red ia
    
    */
// a: canvas
// b: body
    b = document.body
    a.width = innerWidth;
    a.height = innerHeight;
    c = a.getContext("2d")
    RED_MULTIPLIER = 0.1
    BULLET_MULTIPLIER = 0.8
    TIME_STEP = 1
    TIME_LIMIT = 20
    MIN_SPEED = 1
    ENTITY_SIZE = 10
    BULLET_SIZE = 4
    PLAYER_PISTOL_CD = 50
    BULLET_POOL_SIZE = 20
    MAX_RED_GUYS = 20
    RED_GUYS_CD = 1500
    RED_GUYS_SPAWN_CD = 1000
    

    // c: canvas context2d
    // p: player x | y | pistol cd |Â current w
    p = [0,0, -1]
    pv = [0,0]
    // t: time dilatation
    t = 1
    // e: elapsed time
    e = 0
    // r: red guys
    // 1 : cac | 2 : pistol | 3 : shotgun | 4 : auto
    r = []
    // u: bullets
    u = []
    bi = 0// last bullet index
    // f: is fireing
    f = false
    // m: mouse pos
    m = [0,0]
    // CONTROLS
    
    
    /*
     wasd by xem : u=d=l=r=0;onkeyup=t=(e,v)=>top['lurdl*d*l*ur*u'[(e.which-37)%20]]=v;onkeydown=e=>t(e,1)
    */
    U=D=L=R=0;onkeyup=T=(e,v)=>top['LURDL*D*L*UR*U'[(e.which-37)%20]]=v;onkeydown=e=>T(e,1)
    
    b.onmousedown = function(e) {
        f = true
    }
    b.onmouseup = function(e) {
        f = false
    }
    
    
    b.onmousemove = function(e) {
        m[0] = e.x
        m[1] = e.y - e.target.offsetTop
    }
    
    function l() {
        a.width += 0
        /* move player */
        
        p[1] = D ? p[1] + t : p[1]
        p[1] = U ? p[1] - t : p[1]
        
        p[0] = R ? p[0] + t : p[0]
        p[0] = L ? p[0] - t : p[0]
        /* draw player */
        c.fillStyle = "#FFFFFF"
        c.fillRect(p[0]-ENTITY_SIZE/2,p[1]-ENTITY_SIZE/2, ENTITY_SIZE, ENTITY_SIZE)
        
        /* player fire */
        if(p[2]<0 && f) {
            p[2] = PLAYER_PISTOL_CD
            
            addBullet(p,m,0)
            
        } else {
            p[2]--
        }

        /* draw red guy */
        c.fillStyle = "#CC0000"
        r.forEach(function(g) {
            c.fillRect(g[0]-ENTITY_SIZE/2,g[1]-ENTITY_SIZE/2,ENTITY_SIZE,ENTITY_SIZE)
            /* red guys live */
            var aimPlayerVectorStance = stance(p,g)
            g[0] += (p[0] - g[0]) / aimPlayerVectorStance * t * RED_MULTIPLIER
            g[1] += (p[1] - g[1]) / aimPlayerVectorStance * t * RED_MULTIPLIER
           
            if(e % 30 < 1) {
                g[3] = 1
            }
            /* red guy fire */
            if(g[3] < 0) {
                g[3] = RED_GUYS_CD
                /* fire x current, y current, x init, y init, x at, y at, color */
               addBullet(g,p,0)
            } else {
                g[3]--
            }
        })
        
        for(var i = 0; i < BULLET_POOL_SIZE; i++) {
            var bullet = u[i]
            if(bullet) { 
                bullet[0] = bullet[0] - bullet[4] * t * BULLET_MULTIPLIER 
                bullet[1] = bullet[1] - bullet[5] * t * BULLET_MULTIPLIER

                if(stance(bullet, p) < 5) {
                   // u[i] = false

                }
                u.forEach(function(red, redPos) {
                    if(stance(red, bullet) < 5) {
                        //u[redPos] = false
                    }
                })



                /* border */
                c.lineWidth = 9
                c.strokeStyle = "hsl("+bullet[6]*360+",100%,7%)"
                c.beginPath()       
                c.moveTo(bullet[0],bullet[1]);
                c.lineTo(bullet[2],bullet[3]);
                c.stroke(); 
                /* center */
                c.lineWidth = 2
                c.strokeStyle = "hsl("+bullet[6]*360+",100%,85%)"
                c.moveTo(bullet[0],bullet[1]);
                c.stroke(); 
                /* bullet */
                c.fillRect(bullet[0]-BULLET_SIZE/2,bullet[1]-BULLET_SIZE/2, BULLET_SIZE,BULLET_SIZE)
            }
            
        }
        
        
        
        /* create red guys */
        if(e % RED_GUYS_SPAWN_CD < 1 && r.length < MAX_RED_GUYS) {
            r.push([Math.random()*innerWidth,Math.random()*innerHeight,1,0])
        }
        
        
        /* recalc time dilatation */
        t = (U || L || R || D) ? (t += TIME_STEP) : MIN_SPEED
        t = t > TIME_LIMIT ? TIME_LIMIT : t
        /* add elapsed time */
        e+=t
        cleanBullets()
        /* show some data */
        i.innerHTML = "speed : " + t + "<br>time : " + e + "<br>"
    }
    setInterval(l,16)
    
    function stance(a, b) {
        return Math.sqrt((a[0] - b[0]) * (a[0] - b[0]) + (a[1] - b[1]) * (a[1] - b[1])) 
    } 
    
    function addBullet(from, to, color) {
        for(var i = 0; i < BULLET_POOL_SIZE; i ++ ) {
            if(!u[i]) {
                var bulletStance = stance(from, to)
                u[i] = [from[0], from[1], from[0], from[1], (from[0] - to[0]) / bulletStance, (from[1] - to[1]) / bulletStance, color]
                return
            }
        }
    }
    
    function cleanBullets() {
        for(var i =0; i < BULLET_POOL_SIZE; i ++) {
            if(u[i] && (u[i][0] < 0 || u[i][0] > a.width || u[i][1] < 0 || u[i][1] > a.height)) {
                u[i] = false
            }
        }
    }

    
</script>