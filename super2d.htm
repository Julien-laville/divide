<style>
    * {
        margin: 0;padding: 0;font-family: sans-serif;
    }
</style>
<div id="i"></div>
<canvas id="a" style="background:#111517"></canvas>
<script>
// a: canvas
// b: body
    b = document.body
    a.width = innerWidth;
    a.height = innerHeight;
    c = a.getContext("2d")
    RED_MULTIPLIER = 0.1
    BULLET_MULTIPLIER = 0.3
    TIME_STEP = 0.5
    TIME_LIMIT = 8
    MIN_SPEED = 1

// c: canvas context2d
    // p: player
    p = [0,0]
    pv = [0,0]
    // t: time dilatation
    t = 1
    // e: elapsed time
    e = 0
    // r: red guys
    // 1 : cac | 2 : pistol | 3 : shotgun | 4 : auto
    r = []
    // u: bullets
    u = []
    // f: is fireing
    f = false
    // m: mouse pos
    m = [0,0]
    // CONTROLS
    
    /*
     wasd by xem : u=d=l=r=0;onkeyup=t=(e,v)=>top['lurdl*d*l*ur*u'[(e.which-37)%20]]=v;onkeydown=e=>t(e,1)
    */
    U=D=L=R=0;onkeyup=T=(e,v)=>top['LURDL*D*L*UR*U'[(e.which-37)%20]]=v;onkeydown=e=>T(e,1)
    
    b.onmousedown = function(e) {
        f = true
    }
    b.onmouseup = function(e) {
        f = false
    }
    
    b.onmouseover = function(e) {
        m[0] = e.screenX
        m[1] = e.screenY
    }
    
    function l() {
        a.width += 0
        /* move player */
        
        p[1] = D ? p[1] + t : p[1]
        p[1] = U ? p[1] - t : p[1]
        
        p[0] = R ? p[0] + t : p[0]
        p[0] = L ? p[0] - t : p[0]
        /* draw player */
        c.fillStyle = "#FFFFFF"
        c.fillRect(p[0] - 5,p[1] - 5, 10, 10)

        /* draw red guy */
        c.fillStyle = "#CC0000"
        r.forEach(function(g) {
            c.fillRect(g[0]-5,g[1]-5,10,10)
            /* red guys live */
            var aimPlayerVectorStance = stance(p,g)
            g[0] += (p[0] - g[0]) / aimPlayerVectorStance * t * RED_MULTIPLIER
            g[1] += (p[1] - g[1]) / aimPlayerVectorStance * t * RED_MULTIPLIER
            
            if(e % 30 < 1) {
                g[3] = 1
            }
            
            if(g[3]) {
                g[3] = 0
                /* fire x current, y current, x init, y init, x at, y at */
                var bulletStance = stance([g[0],g[1]], [p[0], g[1]])
                u.push([g[0], g[1], g[0], g[1], (g[0] - p[0]) / bulletStance, (g[1] - p[1]) / bulletStance, Math.random()])
            }
        })
        
        u.forEach(function(bullet) {
            bullet[0] = bullet[0] - bullet[4] * t * BULLET_MULTIPLIER 
            bullet[1] = bullet[1] - bullet[5] * t * BULLET_MULTIPLIER
            
            if(stance(bullet, p) < 5) {
                //b.innerHTML = 'Game over'
            }
            
            c.fillRect(bullet[0]-2,bullet[1]-2, 4,4)
            c.strokeStyle = "hsl("+bullet[6]*360+",100%,15%)"
            c.beginPath()       
            
            c.moveTo(bullet[0],bullet[1]);
            c.lineTo(bullet[2],bullet[3]);
            c.stroke(); 
        })
        
        
        

        if(e % 100 < 1 && r.length < 20) {
            r.push([Math.random()*innerWidth,Math.random()*innerHeight,1,0])
        }
        
        
        /* recalc time dilatation */
        t = (U || L || R || D) ? (t += TIME_STEP) : MIN_SPEED
        t = t > TIME_LIMIT ? TIME_LIMIT : t
        /* add elapsed time */
        e+=t
        /* show some data */
        i.innerHTML = "speed : " + t + "<br>time : " + e + "<br>"
    }
    setInterval(l,16)
    
    function stance(a, b) {
        return Math.sqrt((a[0] - b[0]) * (a[0] - b[0]) + (a[1] - b[1]) * (a[1] - b[1])) 
    } 

    
</script>